name: CD - Deploy to Production

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  deployments: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  HELM_CHART_PATH: helm-chart/youtube-to-mp3

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

    - name: Deploy to staging
      run: |
        # Extract image tag from the CI workflow
        IMAGE_TAG="${{ github.sha }}"
        
        helm upgrade --install youtube-to-mp3-staging ${{ env.HELM_CHART_PATH }} \
          --namespace youtube-to-mp3-staging \
          --create-namespace \
          --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
          --set image.tag=main-${IMAGE_TAG:0:7} \
          --set environment=staging \
          --set replicaCount=1 \
          --set resources.requests.cpu=100m \
          --set resources.requests.memory=256Mi \
          --set resources.limits.cpu=500m \
          --set resources.limits.memory=512Mi \
          --wait --timeout=300s

    - name: Run smoke tests
      run: |
        # Wait for deployment to be ready
        kubectl wait --for=condition=available --timeout=300s deployment/youtube-to-mp3-staging -n youtube-to-mp3-staging
        
        # Get service URL
        STAGING_URL=$(kubectl get svc youtube-to-mp3-staging -n youtube-to-mp3-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        # Run basic health check
        curl -f http://${STAGING_URL}:8000/health || exit 1
        
        echo "Staging deployment successful at http://${STAGING_URL}:8000"

  deploy-production:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
    environment: production
    needs: []  # Remove staging dependency for direct production deployment from tags
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}

    - name: Extract version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=latest
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Deploy to production
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        helm upgrade --install youtube-to-mp3 ${{ env.HELM_CHART_PATH }} \
          --namespace youtube-to-mp3-prod \
          --create-namespace \
          --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
          --set image.tag=${VERSION} \
          --set environment=production \
          --set replicaCount=3 \
          --set autoscaling.enabled=true \
          --set autoscaling.minReplicas=3 \
          --set autoscaling.maxReplicas=10 \
          --set resources.requests.cpu=200m \
          --set resources.requests.memory=512Mi \
          --set resources.limits.cpu=1000m \
          --set resources.limits.memory=1Gi \
          --set ingress.enabled=true \
          --set ingress.className=nginx \
          --set ingress.annotations."cert-manager\.io/cluster-issuer"=letsencrypt-prod \
          --set ingress.tls[0].secretName=youtube-to-mp3-tls \
          --set ingress.tls[0].hosts[0]=${{ secrets.PRODUCTION_DOMAIN }} \
          --set ingress.hosts[0].host=${{ secrets.PRODUCTION_DOMAIN }} \
          --set ingress.hosts[0].paths[0].path="/" \
          --set ingress.hosts[0].paths[0].pathType=Prefix \
          --wait --timeout=600s

    - name: Run production health checks
      run: |
        # Wait for deployment to be ready
        kubectl wait --for=condition=available --timeout=600s deployment/youtube-to-mp3 -n youtube-to-mp3-prod
        
        # Run comprehensive health checks
        PROD_URL="https://${{ secrets.PRODUCTION_DOMAIN }}"
        
        # Health check
        curl -f ${PROD_URL}/health || exit 1
        
        # Check metrics endpoint
        curl -f ${PROD_URL}/metrics || echo "Metrics endpoint not available"
        
        echo "Production deployment successful at ${PROD_URL}"

    - name: Notify deployment
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: |
          Production deployment ${{ job.status }}!
          Version: ${{ steps.version.outputs.version }}
          URL: https://${{ secrets.PRODUCTION_DOMAIN }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    runs-on: ubuntu-latest
    if: failure()
    environment: production
    needs: [deploy-production]
    
    steps:
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}

    - name: Rollback deployment
      run: |
        helm rollback youtube-to-mp3 -n youtube-to-mp3-prod
        
        # Wait for rollback to complete
        kubectl wait --for=condition=available --timeout=300s deployment/youtube-to-mp3 -n youtube-to-mp3-prod
        
        echo "Rollback completed successfully"